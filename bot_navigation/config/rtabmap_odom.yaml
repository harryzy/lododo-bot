# ==============================================================================
# RTAB-Map Visual Odometry Configuration / RTAB-Map 视觉里程计配置
# For LeKiwi 3-wheel omnidirectional robot with Astra Pro camera
# 适用于 LeKiwi 三轮全向机器人配备 Astra Pro 相机
# ==============================================================================

rgbd_odometry:
  ros__parameters:
    # ==========================================================================
    # Frame Configuration / 坐标系配置
    # ==========================================================================
    frame_id: base_link           # Robot base frame / 机器人基座坐标系
    odom_frame_id: vo             # Visual odometry frame / 视觉里程计坐标系
    publish_tf: false             # Don't publish TF, let EKF handle it / 不发布TF，由EKF处理
    publish_null_when_lost: false # Don't publish when tracking lost / 追踪丢失时不发布
    
    # ==========================================================================
    # Simulation Time / 仿真时间
    # ==========================================================================
    use_sim_time: true
    
    # ==========================================================================
    # QoS Settings / QoS 设置
    # Critical for proper message synchronization
    # 关键的消息同步设置
    # ==========================================================================
    # QoS values: 0=System Default, 1=Parameter Events (RELIABLE), 2=Sensor Data (BEST_EFFORT)
    # Gazebo camera uses RELIABLE, so we must use RELIABLE (0 or 1) to receive data
    # Gazebo 相机使用 RELIABLE，所以我们必须使用 RELIABLE (0 或 1) 才能接收数据
    qos: 1                        # Use RELIABLE to match Gazebo camera publisher
    qos_camera_info: 1            # Camera info also uses RELIABLE
    
    # ==========================================================================
    # Topic Configuration / 话题配置
    # Remapped in launch file, these are base names
    # 在启动文件中重映射，这里是基础名称
    # ==========================================================================
    subscribe_rgbd: false         # Use separate RGB and Depth topics / 使用分离的RGB和深度话题
    subscribe_depth: true         # Subscribe to depth image / 订阅深度图像
    subscribe_rgb: true           # Subscribe to RGB image / 订阅RGB图像
    
    # ==========================================================================
    # Image Synchronization / 图像同步配置
    # Critical for Gazebo simulation where RGB and Depth timestamps may differ
    # 对于 Gazebo 仿真至关重要，因为 RGB 和 Depth 时间戳可能不同
    # ==========================================================================
    approx_sync: true             # Enable approximate synchronization / 启用近似同步
    approx_sync_max_interval: 0.1 # Max time diff between RGB/Depth (seconds)
                                  # 设为 0.1s，足够允许轻微时间差异但避免重复触发
                                  # Set to 0.1s, enough for slight time differences but avoids duplicate triggers
    
    # ==========================================================================
    # Visual Odometry Parameters / 视觉里程计参数
    # Optimized for simulated textured environment with 60° FOV camera
    # 针对 60° FOV 相机的仿真纹理环境优化
    # ==========================================================================
    
    # Odometry Strategy / 里程计策略
    # 0=Frame-to-Map (F2M), 1=Frame-to-Frame (F2F)
    # F2F is more robust for challenging environments with limited features
    # F2F 对于特征有限的挑战性环境更加鲁棒
    Odom/Strategy: "1"            # Frame-to-Frame for better robustness in simulation
    
    # Feature Type / 特征类型
    # 0=SURF, 2=ORB, 6=GFTT/BRIEF, 8=GFTT/ORB, 9=BRISK, 14=BEBLID
    # ORB (2) is faster and works better in low-texture environments
    # ORB (2) 更快且在低纹理环境中效果更好
    Vis/FeatureType: "2"          # Pure ORB - better for simulation
    
    # Maximum Features / 最大特征数
    # Increased significantly for better tracking during motion
    # 大幅增加以在运动中获得更好的跟踪
    Vis/MaxFeatures: "2000"       # Increased from 1000 to 2000 for more robust tracking
    
    # Minimum Inliers / 最小内点数
    # Further lowered to allow odometry even with very few matches
    # 进一步降低以允许在匹配很少时也能进行里程计
    Odom/MinInliers: "5"          # Reduced from 10 to 5 for more tolerance
    
    # Reset Count Down / 重置倒计时
    # Significantly increased tolerance before reset
    # 大幅增加重置前的容错
    Odom/ResetCountdown: "10"     # Increased from 5 to 10 for much more tolerance
    
    # ==========================================================================
    # Feature Detection Parameters / 特征检测参数
    # Optimized for simulated environment / 针对仿真环境优化
    # ==========================================================================
    
    # GFTT (Good Features To Track) Parameters
    # Shi-Tomasi corner detection parameters
    GFTT/MinDistance: "3"         # Reduced for more features / 减小以获得更多特征
    GFTT/QualityLevel: "0.0001"   # Further lowered = even more features / 进一步降低 = 更多特征
    GFTT/BlockSize: "3"           # Block size for corner detection
    GFTT/UseHarrisDetector: "false"  # Use Shi-Tomasi instead of Harris
    
    # ORB Parameters / ORB 参数
    # Optimized for simulated textured walls / 针对仿真纹理墙壁优化
    ORB/ScaleFactor: "1.2"        # Pyramid scale factor
    ORB/NLevels: "8"              # Pyramid levels
    ORB/EdgeThreshold: "15"       # Reduced from 19 to detect more features near edges
    ORB/FirstLevel: "0"           # First pyramid level
    ORB/WTA_K: "2"                # Points for BRIEF descriptor
    ORB/PatchSize: "31"           # Patch size for oriented BRIEF
    ORB/FastThreshold: "5"        # Reduced from 10 for more keypoints in low-texture areas
    
    # ==========================================================================
    # Depth Image Parameters / 深度图像参数
    # ==========================================================================
    
    # Depth Range / 深度范围
    # Matching camera plugin settings in Gazebo
    # 与 Gazebo 相机插件设置匹配
    Vis/MinDepth: "0.1"           # Minimum depth (meters)
    Vis/MaxDepth: "5.0"           # Maximum depth (meters) - reduced for indoor
    
    # Depth Decimation / 深度抽取
    # Reduce resolution for faster processing
    # 降低分辨率以加快处理
    decimation: 2                  # Decimate depth by factor of 2
    
    # ==========================================================================
    # Motion Model / 运动模型
    # ==========================================================================
    
    # Guess from Motion / 从运动预测
    # Use previous motion to predict current transformation
    # 使用先前运动预测当前变换
    Odom/GuessMotion: "true"
    
    # Key Frame Threshold / 关键帧阈值
    # Add keyframe when movement exceeds threshold
    # 当移动超过阈值时添加关键帧
    Odom/KeyFrameThr: "0.4"       # Keyframe on significant movement
    
    # ==========================================================================
    # Image Processing / 图像处理
    # ==========================================================================
    
    # Image Decimation / 图像抽取
    # Faster processing at cost of accuracy
    # 以精度换取更快的处理速度
    Vis/ImageDecimation: "1"      # No decimation for better accuracy
    
    # Maximum Depth Error / 最大深度误差
    # Reject features with large depth variance
    # 拒绝深度方差大的特征
    Vis/MaxDepthError: "0.1"
    
    # ==========================================================================
    # RANSAC Parameters / RANSAC 参数
    # For outlier rejection / 用于异常值剔除
    # Relaxed for more tolerance during motion
    # 放宽以在运动中获得更多容错
    # ==========================================================================
    
    # RANSAC Iterations / RANSAC 迭代次数
    Vis/Iterations: "500"         # Increased from 300 for better outlier rejection
    
    # RANSAC Inlier Distance / RANSAC 内点距离
    Vis/InlierDistance: "0.05"    # Relaxed from 0.02 to 5cm threshold
    
    # PnP Estimation Method / PnP 估计方法
    # 1=Iterative, 2=EPNP, 3=P3P, 4=DLS, 5=UPNP
    Vis/PnPFlags: "2"             # EPNP - good balance
    
    # PnP Reprojection Error / PnP 重投影误差
    Vis/PnPReprojError: "4.0"     # Relaxed from 2.0 to 4.0 pixel error threshold
    
    # ==========================================================================
    # Bundle Adjustment / 捆绑调整
    # For F2M strategy refinement / 用于F2M策略优化
    # ==========================================================================
    
    # Local Bundle Adjustment / 局部捆绑调整
    Odom/F2MScanMaxSize: "3"      # Max scans in local map
    OdomF2M/BundleAdjustment: "1" # Enable bundle adjustment
    OdomF2M/MaxSize: "3000"       # Max features in local map
    
    # ==========================================================================
    # Output Configuration / 输出配置
    # ==========================================================================
    
    # Covariance Scaling / 协方差缩放
    # Scale covariance for sensor fusion
    # 为传感器融合缩放协方差
    Odom/VarianceFromInliersCount: "true"  # Scale variance by inlier count
    
    # ==========================================================================
    # Expected Update Rate / 预期更新频率
    # Should match or exceed camera frame rate
    # 应与相机帧率匹配或更高
    # ==========================================================================
    expected_update_rate: 30.0    # Set higher to accommodate Gazebo variable framerate
                                  # 设置更高以适应 Gazebo 可变帧率
    
    # ==========================================================================
    # Wait for Transform / 等待变换
    # TF lookup timeout / TF 查找超时
    # ==========================================================================
    wait_for_transform: 0.2       # 200ms timeout for TF lookup
